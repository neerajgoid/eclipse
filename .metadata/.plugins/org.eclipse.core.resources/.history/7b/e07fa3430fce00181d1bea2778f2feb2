package jdbc;


import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.Scanner;

public class DBConnect {
	
	public Connection connect() throws SQLException, ClassNotFoundException {
		Connection con = null;
		String url ="jdbc:mysql://localhost:3306/neeraj?autoReconnect=true&useSSL=false";
		String user ="root";
		String password = "root";
	
		con = DriverManager.getConnection(url, user, password);
		return con;
		
	}
	
	
	public void insertRecord() throws SQLException, ClassNotFoundException {
		Connection con = null;
		Statement stmt = null;
		PreparedStatement ps=null;
		ResultSet rs = null;
	
		try {
			con = connect();
			System.out.println("Enter your name");
			Scanner scanner = new Scanner(System.in);
			String name = scanner.nextLine();
			int newId=0;
			if(con!=null) {
				
				String query = "Select count(*) from customer";
				stmt = con.createStatement();
				rs = stmt.executeQuery(query);
		
				if(rs.first()) {
					System.out.println("Upto ID:" + rs.getInt(1)+ "exists"); 
					newId = rs.getInt(1);
					
				}
				
				String query1 = "Insert into customer values (?,?)";
			
				ps = con.prepareStatement(query1);
				ps.setInt(1, ++newId);
				ps.setString(2, name);
				ps.executeUpdate();
				System.out.println("ID: " + newId + "is generated for you");
				scanner.close();
				displayProducts(newId);
				
			}
		} catch (ClassNotFoundException | SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		finally {
			
			rs.close();
			stmt.close();
			ps.close();
			con.close();
		}
		
		// show product list
	
	}
	
	
	public void checkDB(int id) throws SQLException {
		Connection con=null;
		ResultSet rs = null;
		PreparedStatement ps = null;
		
		String query = "Select cust_id from customer where cust_id = ?";
		try {
			con = connect();
			
			if(con!=null) {
				ps = con.prepareStatement(query);
				ps.setInt(1, id);
			rs=	ps.executeQuery();
			
			if(rs.first()) {
				System.out.println("Yes User with ID:" + rs.getInt(1)+ "exists");
				System.out.println("************PRODUCT LIST****************");
				displayProducts(rs.getInt(1));
			}
			else{ // if no record exists
				insertRecord();
			}
			
			}
		} 
		catch (ClassNotFoundException | SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
		finally {
			rs.close();
			ps.close();
			con.close();
		}
		
			
		
	}
	
	
	public void displayProducts(int id) throws ClassNotFoundException, SQLException {
		Connection con=null;
		Statement stmt = null;
		ResultSet rs = null;
		
			con = connect();
			if(con!=null) {
				
				String query = "select * from products order by category,name"; // how come no semicolon needed?
				
				stmt = con.createStatement();
				rs = stmt.executeQuery(query);
				
				while(rs.next())
				{
					System.out.println("Product Id:" + rs.getInt(1) + " Name: " + rs.getString(2) + " Category: " + rs.getString(3));
				}
			
			rs.close();
			stmt.close();
			con.close();
			
			}
			orderCreate(id); // just creates an entry into the table of Orders
	}
	
	
	public void orderCreate(int id) throws SQLException, ClassNotFoundException {
		int choice=0;
		Scanner sc = new Scanner(System.in);
		
		Connection con =null;
		Statement stmt = null;
		PreparedStatement ps=null;
		ResultSet rs = null;
			con = connect();
			int count=0;
		if(con!=null) {
		//	String query = "Select name from customer where id = " + id;
			
		//	stmt = con.createStatement();
		//	rs = stmt.executeQuery(query);
			
			String query = "Select count(*) from orders";
			stmt = con.createStatement();
			rs = stmt.executeQuery(query);
			
			if(rs.first()) {
				count = rs.getInt(1);
				
				String query1 = "Insert into orders values(?,?)";
				
				ps = con.prepareStatement(query1);
				ps.setInt(1, ++count);
				ps.setInt(2, id);
				ps.executeUpdate();
				
				ps.close();
			}
			
				acceptOrder(count); // passing the order id to orderItem table
		
		}
		
	/*	do {
			System.out.println("Please choose if you want to add an item 1.Yes 2.No");
			choice = sc.nextInt();
			
			if(choice == 1) {
				
			}
			
		}while(choice!=2);
		
		*/
		rs.close();
		stmt.close();
		con.close();
		sc.close();
	}
	
	
	public void acceptOrder(int orderId) throws SQLException, ClassNotFoundException {
		Scanner sc = new Scanner(System.in);
		int choice=1;
	//	System.out.println("orderId passed to accept order is" + orderId);
		Connection con=null;
		Statement stmt = null;
		ResultSet rs = null;
		PreparedStatement ps = null;
		
		con = connect();
		if(con!=null) {
			
		
		while(choice!=0) {
		System.out.println("********************************");
			System.out.println("Please enter the id of the product you want to add in your order or \n press 0 to exit");
			int productId = sc.nextInt();
			choice = productId ;
			if(choice == 0)
				break;
			System.out.println("Enter the quantity for that product that you want");
			int quantity = sc.nextInt();
			
			String query = "Select count(*) from orderItem";
			stmt = con.createStatement();
			rs = stmt.executeQuery(query);
			
			if(rs.first()) {
				int count = rs.getInt(1);
			String query1 = "Insert into orderItem values (?,?,?,?)";
			
				ps = con.prepareStatement(query1);
					ps.setInt(1,++count);
					ps.setInt(2, orderId);
					ps.setInt(3, productId);
					ps.setInt(4, quantity);
					
					int affect= ps.executeUpdate();
					System.out.println(affect + " row(s) affected ");
					ps.close();
				
			}
			rs.close();
			stmt.close();
		}
		// select orders.cust_id,orders.order_id,orderItem.product_id,orderItem.quantity from orderItem,orders where orderItem.order_id = orders.order_id and cust_id = 3
	//	String query = "Select * from orderItem where"
		
		}
		con.close();
	}
	
	public void checkOrder() throws ClassNotFoundException, SQLException {
		Scanner sc = new Scanner(System.in);
		System.out.println("Enter your customer Id");
		int custId = sc.nextInt();
		
		Connection con = null;
		Statement stmt = null;
		ResultSet rs = null;
		
		con = connect();
		if(con!=null) {
			String query = "select orders.order_id,orderItem.product_id,orderItem.quantity from orderItem,orders where orderItem.order_id = orders.order_id and cust_id = "+ custId; 
			
			stmt = con.createStatement();
			rs = stmt.executeQuery(query);
			displayProducts(custId); // to show the Item Name and Item Id
			
			System.out.println("Your orders are:");
			while(rs.next()) {
				
				System.out.println("Order Id :"+ rs.getInt(1) + " Item Id: " + rs.getInt(2) + " Quantity : " + rs.getInt(3));
			}
			
			System.out.println("Please choose the Order Id which you want to update ");
			int billNo = sc.nextInt();
			
			System.out.println("Please choose if you want to 1.update or 2.delete a product from the order id" + billNo);
			int choice = sc.nextInt();
			
			if(choice == 1 ) {
				updateOrder(custId,billNo);
			}
			else{
				
			}
				
			
		}
	}
	
	public void updateOrder(int custId, int orderid) throws ClassNotFoundException, SQLException {
		Connection con = null;
		PreparedStatement ps = null;
		Statement stmt = null;
		ResultSet rs = null;
		Scanner sc = new Scanner(System.in);
		con = connect();
		if(con!=null) {
			String query = "select orderItem.product_id,orderItem.quantity from orderItem,orders where orderItem.order_id = orders.order_id and cust_id =" + custId + " and orders.order_id="+orderid; ;;
			
			stmt = con.createStatement();
			rs = stmt.executeQuery(query);
			displayProducts(custId);
			System.out.println("Your items for order id:"+orderid+ " are");
			while(rs.next()) {
				
				System.out.println(" Item Id: " + rs.getInt(1) + " Quantity : " + rs.getInt(2));
			}
			
			System.out.println("Enter the Id no of the Product who's quantity you want to change");
			int prodId = sc.nextInt();
			
			System.out.println("Enter the new quantity for the product with id"+ prodId);
			int quantity = sc.nextInt();
			
		//update orderItem set quantity = 10 where order_id=1 and product_id = 1;
			
			String query1 = "update orderItem set quantity = ? where order_id=? and product_id = ?"; 
			
			ps = con.prepareStatement(query1);
			ps.setInt(1, quantity);
			ps.setInt(2, orderid);
			ps.setInt(3, prodId);
			
			
			
		}
		
		
		
		
	}
	
	
}
